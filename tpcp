#! /usr/bin/env bash

set -euo pipefail

# -- absolute dirpath ---------------------------------------------------------

ABSOLUTE_DIRPATH="${0}"

# this works on both linux and macOS
if [[ -L "${0}" ]]; then
    ABSOLUTE_DIRPATH="$(readlink "${0}")"

    if [[ "${ABSOLUTE_DIRPATH}" == "" ]]; then
        >&2 echo "Cannot determine real path of the script."
        exit 1
    fi
fi

ABSOLUTE_DIRPATH="$(dirname "${ABSOLUTE_DIRPATH}")"

# -- load libraries -----------------------------------------------------------

. "${ABSOLUTE_DIRPATH}/libs/ansi"
. "${ABSOLUTE_DIRPATH}/libs/logger"
. "${ABSOLUTE_DIRPATH}/libs/inputparser"
. "${ABSOLUTE_DIRPATH}/libs/utils"
. "${ABSOLUTE_DIRPATH}/libs/ssh"
. "${ABSOLUTE_DIRPATH}/libs/saptransport"
. "${ABSOLUTE_DIRPATH}/libs/renderer"

# -- initial setup ------------------------------------------------------------
logger::init "N"

# -- handle input parameters --------------------------------------------------

IP_TRANSPORT_LIST=()
IP_SYSTEM_LIST=()
IP_ACTION_LIST=()

if [[ ${#} -ne 3 ]]; then
    tpcp::utils::usage
    tpcp::utils::terminate
fi

tpcp::inputparser::parse_transport_list "${1}"
tpcp::inputparser::parse_system_list "${2}"
tpcp::inputparser::parse_action_list "${3}"

# -- main program -------------------------------------------------------------

if ! [[ ${TPCP_CONFIG_FILEPATH+_} ]]; then
    tpcp::utils::terminate "Environment variable TPCP_CONFIG_FILEPATH is not set."
fi

saptransport::load_ini_file "${TPCP_CONFIG_FILEPATH}"

TPCP_WORK_DIRPATH="/tmp/tpcp.${RANDOM}.${$}"

if [[ ! -d "${TPCP_WORK_DIRPATH}" ]]; then
    mkdir "${TPCP_WORK_DIRPATH}" # || terminate
fi

# record initial status
for transport in "${IP_TRANSPORT_LIST[@]}"; do
    for system in "${IP_SYSTEM_LIST[@]}"; do
        for action in "${IP_ACTION_LIST[@]}"; do
            saptransport::record_status "${SAPTRANSPORT_STATUS_INITIAL}" "${TPCP_WORK_DIRPATH}" "${transport}" "${system}" "${action}"
        done
    done
done

# process all transports on all systems
for transport in "${IP_TRANSPORT_LIST[@]}"; do
    saptransport::process_transport "${transport}" "IP_SYSTEM_LIST[@]" "IP_ACTION_LIST[@]" # hack to pass 2 arrays as argument
done &

sleep 1

while : ; do
    tpcp::renderer::render

    # BUG: When job dies, its status doesn't change and this function will return false forever.
    if saptransport::is_all_done; then
        sleep 1
        tpcp::renderer::render
        break
    fi

    sleep 1
done

wait

# -- cleanup ------------------------------------------------------------------

rm -rf "${TPCP_WORK_DIRPATH}"
