#! /usr/bin/env bash

set -euo pipefail

# -- absolute dirpath ---------------------------------------------------------

ABSOLUTE_DIRPATH="${0}"

# this works on both linux and macOS
if [[ -L "${0}" ]]; then
    ABSOLUTE_DIRPATH="$(readlink "${0}")"

    if [[ "${ABSOLUTE_DIRPATH}" == "" ]]; then
        >&2 echo "Cannot determine real path of the script."
        exit 1
    fi
fi

ABSOLUTE_DIRPATH="$(dirname "${ABSOLUTE_DIRPATH}")"

# -- load libraries -----------------------------------------------------------

. "${ABSOLUTE_DIRPATH}/libs/ansi"
. "${ABSOLUTE_DIRPATH}/libs/logger"
. "${ABSOLUTE_DIRPATH}/libs/inputparser"
. "${ABSOLUTE_DIRPATH}/libs/utils"
. "${ABSOLUTE_DIRPATH}/libs/saptransport"

# -- initial setup ------------------------------------------------------------
logger::init "N"

# -- handle input parameters --------------------------------------------------

IP_TRANSPORT_LIST=()
IP_SYSTEM_LIST=()
IP_ACTION_LIST=()

if [[ ${#} -ne 3 ]]; then
    tpcp::utils::usage
    tpcp::utils::terminate
fi

tpcp::inputparser::parse_transport_list "${1}"
tpcp::inputparser::parse_system_list "${2}"
tpcp::inputparser::parse_action_list "${3}"

# -- main program -------------------------------------------------------------

# process all transports on all systems
for transport in "${IP_TRANSPORT_LIST[@]}"; do
    saptransport::process_transport "${transport}" "IP_SYSTEM_LIST[@]" "IP_ACTION_LIST[@]" # hack to pass 2 arrays as argument
done
